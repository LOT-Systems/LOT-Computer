name: lot-systems
region: nyc3

services:
  - name: web
    # GitHub repository configuration
    git:
      branch: claude/LOT_updates_November_2025-01XjLLhgKKL2Syne7Q1nqoGS
      repo_clone_url: https://github.com/vadikmarmeladov/lot-systems.git

    # Build configuration
    build_command: |
      set -e
      echo "üöÄ Build started at $(date)"
      echo "üì¶ Installing dependencies..."
      yarn install --frozen-lockfile --production=false 2>&1 | tail -20
      echo "‚úÖ Dependencies installed at $(date)"
      echo ""
      echo "üé® Building client CSS..."
      NODE_ENV=production yarn client:css:build
      echo "‚úÖ Client CSS built at $(date)"
      echo ""
      echo "üì¶ Building client JS..."
      NODE_ENV=production yarn client:js:build
      echo "‚úÖ Client JS built at $(date)"
      echo ""
      echo "üî® Building server..."
      NODE_ENV=production yarn server:build
      echo "‚úÖ Server built at $(date)"
      echo ""
      echo "üóÑÔ∏è Running database migrations..."
      yarn migrations:up
      echo "‚úÖ Migrations completed at $(date)"
      echo ""
      echo "üìÅ Verifying build output..."
      echo "Contents of dist/:"
      ls -la dist/ || echo "dist/ not found"
      echo "Contents of dist/server/:"
      ls -la dist/server/ || echo "dist/server/ not found"
      echo "Contents of dist/server/server/:"
      ls -la dist/server/server/ | head -10 || echo "dist/server/server/ not found"
      echo "Contents of dist/client/js/:"
      ls -la dist/client/js/ | head -10 || echo "dist/client/js/ not found"
      echo "‚úÖ Build completed at $(date)"

    # Runtime configuration
    run_command: node dist/server/server/index.js
    environment_slug: node-js
    instance_size_slug: basic-xxs
    instance_count: 1
    http_port: 8080

    # Health check configuration
    health_check:
      http_path: /health
      initial_delay_seconds: 30
      period_seconds: 10
      timeout_seconds: 5
      success_threshold: 1
      failure_threshold: 3

    # Environment variables
    envs:
      # Node.js Environment
      - key: NODE_ENV
        scope: RUN_AND_BUILD_TIME
        value: production

      - key: PORT
        scope: RUN_TIME
        value: "8080"

      # Build metadata
      - key: BUILD_DATE
        scope: RUN_AND_BUILD_TIME
        value: "${_self.CREATED_AT}"

      # Application Configuration
      - key: APP_NAME
        scope: RUN_AND_BUILD_TIME
        value: LOT

      - key: APP_HOST
        scope: RUN_AND_BUILD_TIME
        value: "https://lot-systems.com"

      - key: APP_DESCRIPTION
        scope: RUN_AND_BUILD_TIME
        value: "LOT is a subscription service that distributes digital and physical necessities, basic wardrobes, organic self-care products, home and kids essentials."

      # Database Configuration (PostgreSQL)
      - key: DATABASE_URL
        scope: RUN_AND_BUILD_TIME
        type: SECRET
        value: postgresql://doadmin:AVNS_8V6Hqzuxwj0JkMxgNvR@db-postgresql-nyc3-92053-do-user-22640384-0.f.db.ondigitalocean.com:25060/defaultdb?sslmode=require

      - key: DB_HOST
        scope: RUN_AND_BUILD_TIME
        type: SECRET
        value: db-postgresql-nyc3-92053-do-user-22640384-0.f.db.ondigitalocean.com

      - key: DB_PORT
        scope: RUN_AND_BUILD_TIME
        value: "25060"

      - key: DB_NAME
        scope: RUN_AND_BUILD_TIME
        value: defaultdb

      - key: DB_USER
        scope: RUN_AND_BUILD_TIME
        type: SECRET
        value: doadmin

      - key: DB_PASSWORD
        scope: RUN_AND_BUILD_TIME
        type: SECRET
        value: AVNS_8V6Hqzuxwj0JkMxgNvR

      - key: DB_SSL
        scope: RUN_AND_BUILD_TIME
        value: "true"

      # JWT Configuration
      - key: JWT_SECRET
        scope: RUN_AND_BUILD_TIME
        type: SECRET
        value: 13919320b2a8816ced947b7a6385811b

      # Email Service Configuration (Resend)
      - key: RESEND_API_KEY
        scope: RUN_TIME
        type: SECRET
        value: re_83s23f6W_LbDfdmmXpXJ4je4i2kt1HA7u

      - key: RESEND_FROM_EMAIL
        scope: RUN_TIME
        value: support@lot-systems.com

      - key: RESEND_FROM_NAME
        scope: RUN_TIME
        value: LOT

      # AI/ML API Keys
      - key: ANTHROPIC_API_KEY
        scope: RUN_TIME
        type: SECRET
        value: sk-ant-api03-mUyBScB4JoNdfYJm1rA8zPv_bitstkNpfa9LZnvur6D8Hi6WYUEwvdmYStLlmzOmJxKa3hYESub-wvqPsLVETg-TP4RhQAA

      - key: OPENAI_API_KEY
        scope: RUN_TIME
        type: SECRET
        value: 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

      - key: TOGETHER_API_KEY
        scope: RUN_TIME
        type: SECRET
        value: 91f01cf8fcba1d44dbf5e2b712210edfffecd6d7f6e5e50816cd50d1efa8414c

# Alerts (optional - uncomment to enable)
# alerts:
#   - rule: DEPLOYMENT_FAILED
#   - rule: DOMAIN_FAILED
